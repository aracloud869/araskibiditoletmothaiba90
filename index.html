<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Cloud Phone Pro — PRO MAX</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<style>
/* ===========================
   RESET + BASE
   =========================== */
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none;outline:none}
html,body{height:100%;margin:0;padding:0}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  background:#f2f4f8;color:#111827;height:100vh;overflow:hidden;
  -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
}

/* APP LAYOUT */
#app{width:100%;height:100%;display:flex;flex-direction:column;position:relative;background:#f2f4f8;max-width:900px;margin:0 auto;}
#content{flex:1;overflow-y:auto;padding:18px;padding-bottom:130px;scrollbar-width:none}
#content::-webkit-scrollbar{display:none}

/* HEADER */
.header-area{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;padding-top:10px}
.header-title{font-size:1.6rem;font-weight:800;color:#0f1724;margin:0}
.btn-add-device{background:#2563eb;color:#fff;border:none;padding:8px 16px;border-radius:20px;font-weight:700;display:inline-flex;gap:8px;align-items:center;cursor:pointer;box-shadow:0 6px 18px rgba(37,99,235,0.14)}

/* TAB + TRANSITIONS */
.tab-content{display:none;animation:fadeSlide .32s ease-out}
.tab-content.active{display:block}
@keyframes fadeSlide{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* CARD */
.card{background:#fff;border-radius:14px;padding:12px;margin-bottom:12px;box-shadow:0 6px 20px rgba(14,30,37,0.04);border:1px solid rgba(15,23,42,0.04)}
.info-card{padding:14px;border-radius:12px;background:#fff;box-shadow:0 4px 12px rgba(2,6,23,0.03);margin-bottom:12px}

/* DEVICE CARD */
.device-card{background:#fff;border-radius:14px;padding:12px;margin-bottom:12px;box-shadow:0 4px 10px rgba(2,6,23,0.03);border:1px solid rgba(0,0,0,0.04);display:flex;flex-direction:column;gap:10px;transition:transform .15s ease,box-shadow .15s}
.device-card:active{transform:scale(.985)}
.dev-top{display:flex;gap:12px;align-items:center}
.dev-icon{width:54px;height:54px;border-radius:12px;background:linear-gradient(135deg,#eef2ff,#dbeafe);display:flex;align-items:center;justify-content:center;color:#2563eb;font-size:1.4rem;flex-shrink:0}
.dev-info{flex:1}
.dev-name{font-size:1rem;font-weight:800;margin:0;color:#0f1724}
.dev-status{font-size:.85rem;color:#6b7280;display:flex;align-items:center;gap:8px}

/* LED gradient */
.led-text{font-weight:800;background:linear-gradient(90deg,#ef4444,#f59e0b,#10b981,#3b82f6,#a78bfa);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:glide 3s linear infinite}
@keyframes glide{to{background-position:200% center}}

/* DEVICE ACTIONS */
.dev-actions{display:flex;gap:8px;border-top:1px solid #f3f4f6;padding-top:10px}
.btn-act{flex:1;border:none;border-radius:10px;padding:9px 0;font-weight:700;cursor:pointer}
.btn-enter{background:#16a34a;color:#fff}
.btn-del{background:#fee2e2;color:#dc2626}

/* BOTTOM NAV */
#bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);max-width:900px;width:100%;height:76px;background:#fff;display:flex;align-items:center;justify-content:space-around;border-top:1px solid #e6edf3;z-index:120;padding-bottom:10px}
.nav-item{background:none;border:none;display:flex;flex-direction:column;align-items:center;gap:4px;color:#9aa4b2;font-size:.78rem;cursor:pointer;padding:6px 12px}
.nav-item i{font-size:1.25rem;transition:transform .12s}
.nav-item.active{color:#2563eb}
.nav-item.active i{transform:translateY(-3px)}

/* GAME HORIZONTAL */
.game-list-horizontal{display:flex;gap:12px;overflow-x:auto;padding-bottom:6px;margin-bottom:16px}
.game-card{flex:0 0 128px;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 8px 22px rgba(2,6,23,0.04);cursor:pointer;transition:transform .15s,box-shadow .15s}
.game-card:hover{transform:translateY(-6px);box-shadow:0 14px 36px rgba(2,6,23,0.08)}
.game-card-img{height:88px;background:#eef;display:flex;align-items:center;justify-content:center}
.game-card img{width:100%;height:100%;object-fit:cover}

/* GAME LIST MODAL */
.game-item{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f3f4f6}
.game-item-info{display:flex;align-items:center;gap:10px}
.game-item-info strong{display:block;font-size:1rem;color:#0f1724}
.btn-play{background:#10b981;color:#fff;padding:8px 12px;border-radius:8px;border:none;font-weight:700;cursor:pointer}

/* SEARCH INPUTS */
.search-input{width:100%;padding:10px;border-radius:12px;border:1px solid #e6edf3;font-size:.95rem;margin-bottom:12px}

/* CLOUD VIEW & CONTROLS */
#cloud-view{position:fixed;inset:0;background:#000;display:none;z-index:1000;align-items:stretch;flex-direction:column}
#cloud-iframe{flex:1;border:none;width:100%;height:100%}
.cloud-toolbar{position:absolute;top:12px;right:12px;display:flex;gap:8px;z-index:1001}
.cloud-btn{background:rgba(255,255,255,0.06);color:#fff;border:1px solid rgba(255,255,255,0.12);padding:8px;border-radius:10px;cursor:pointer;font-weight:700;backdrop-filter:blur(4px)}
.cloud-status{position:absolute;top:12px;left:12px;background:rgba(0,0,0,0.6);color:#fff;padding:6px 10px;border-radius:999px;font-weight:700}

/* FPS monitor */
.fps-monitor{position:fixed;right:14px;bottom:92px;background:rgba(17,24,39,0.9);color:#fff;padding:8px 10px;border-radius:10px;font-weight:800;z-index:130;font-size:.85rem;display:none}

/* CONTROLS MENU */
.assist-menu{position:absolute;top:50%;right:80px;transform:translateY(-50%);background:rgba(20,20,20,0.93);padding:10px;border-radius:12px;display:none;flex-direction:column;gap:8px;width:200px;z-index:1002}
.menu-row{color:#fff;padding:10px;border-radius:8px;display:flex;align-items:center;gap:8px;cursor:pointer}

/* ANIMATIONS */
@keyframes pulseGlow{0%{box-shadow:0 0 0 rgba(99,102,241,0.18)}50%{box-shadow:0 12px 30px rgba(99,102,241,0.08)}100%{box-shadow:0 0 0 rgba(99,102,241,0)}}

/* DARK MODE */
.dark-mode{background:#061025;color:#dbeafe}
.dark-mode .card,.dark-mode .info-card,.dark-mode .device-card,.dark-mode .game-card{
  background:#071226;color:#dbeafe;border:1px solid rgba(255,255,255,0.04);box-shadow:none;
}
.dark-mode .dev-icon{background:linear-gradient(135deg,#0f1724,#0b1224);color:#60a5fa}
.dark-mode .nav-item{color:#94a3b8}
.dark-mode .nav-item.active{color:#60a5fa}
.dark-mode .search-input{background:#041025;border:1px solid #072036;color:#cfe8ff}

/* RESPONSIVE */
@media (max-width:520px){
  .game-card{flex:0 0 110px}
  #bottom-nav{height:84px}
}

.text-muted{color:#6b7280;font-size:.9rem}
</style>
</head>

<body>

<div id="app">
    <div id="content">

        <!-- ===========================
             TAB HOME
        ============================ -->
        <div id="tab-home" class="tab-content active">
            <div class="header-area">
                <h2 class="header-title">Trang Chủ</h2>
            </div>

            <div style="
                background: linear-gradient(135deg,#2563eb,#1d4ed8);
                padding:22px;border-radius:18px;color:white;
                margin-bottom:18px;box-shadow:0 10px 30px rgba(37,99,235,0.16);
            ">
                <h3 style="margin:0 0 6px 0;font-size:1.4rem;">Cloud Phone PRO MAX</h3>
                <p style="margin:0;font-size:.95rem;opacity:.92;">
                    Treo game 24/7 • No lag • FPS cao • Không nóng máy
                </p>

                <button 
                    onclick="switchTab('devices', document.querySelector('.nav-item:nth-child(2)'))"
                    style="
                        margin-top:14px;padding:10px 22px;background:white;
                        color:#2563eb;font-weight:800;border-radius:22px;border:none;cursor:pointer;
                    ">
                    Tới thiết bị
                </button>
            </div>

            <h4 style="margin:0 0 10px 0;color:#4b5563;font-size:1rem;">Dịch vụ nổi bật</h4>

            <div class="info-card">
                <h3><i class="fas fa-rocket" style="color:#facc15;margin-right:6px;"></i> Tăng tốc Cloud 3X</h3>
                <p class="text-muted">Tối ưu FPS khi chơi game trên cloud.</p>
            </div>

            <div class="info-card">
                <h3><i class="fas fa-shield-alt" style="color:#22c55e;margin-right:6px;"></i> Bảo mật cấp hệ thống</h3>
                <p class="text-muted">Mã hoá đường truyền + ẩn IP + sandbox isolation.</p>
            </div>
        </div>

        <!-- ===========================
             TAB DEVICES
        ============================ -->
        <div id="tab-devices" class="tab-content">
            <div class="header-area">
                <h2 class="header-title">Thiết Bị</h2>
                <button class="btn-add-device" onclick="openModal('modal-buy')">
                    <i class="fas fa-plus"></i> Mua Device
                </button>
            </div>

            <div id="device-list">
                <div id="empty-state" style="text-align:center;margin-top:60px;color:#9ca3af;">
                    <i class="fas fa-mobile-alt" style="font-size:3rem;opacity:.3;"></i>
                    <p>Chưa có thiết bị nào</p>
                </div>
            </div>
        </div>

        <!-- ===========================
             TAB EXPLORE
        ============================ -->
        <div id="tab-explore" class="tab-content">
            <div class="header-area">
                <h2 class="header-title">Khám Phá</h2>
            </div>

            <input id="search-game" class="search-input" placeholder="Tìm game..." oninput="filterGames()">

            <div class="game-list-horizontal" id="game-horizontal"></div>

            <div class="info-card" style="display:flex;align-items:center;justify-content:space-between;">
                <div>
                    <h3><i class="fas fa-layer-group" style="color:#2563eb;margin-right:6px;"></i> Tất cả Game Cloud</h3>
                    <p class="text-muted" style="margin-top:6px;">Danh sách đầy đủ + tìm kiếm nâng cao.</p>
                </div>

                <button class="btn-add-device btn-view-games" onclick="loadAndShowGames()">
                    <i class="fas fa-th"></i> Xem
                </button>
            </div>

            <div class="info-card" onclick="openDiscordLink()" style="cursor:pointer;">
                <h3>
                    <i class="fab fa-discord" style="color:#5865F2;margin-right:6px;"></i>
                    Tham gia Discord
                </h3>
                <p class="text-muted">Nhóm cộng đồng hỗ trợ nhanh nhất.</p>
            </div>

            <div class="info-card">
                <h3><i class="fas fa-gift" style="color:#ec4899;margin-right:6px;"></i> Sự kiện</h3>
                <p class="text-muted">Nhận quà mỗi ngày khi đăng nhập.</p>
            </div>
        </div>

        <!-- ===========================
             TAB SETTINGS
        ============================ -->
        <div id="tab-settings" class="tab-content">

            <div class="header-area">
                <h2 class="header-title">Cài Đặt</h2>
            </div>

            <div class="info-card" style="padding:0;overflow:hidden;">

                <div style="padding:15px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;gap:10px;cursor:pointer;">
                    <i class="fas fa-user-circle" style="color:#2563eb;width:26px;"></i>
                    Tài khoản
                </div>

                <div style="padding:15px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;gap:10px;cursor:pointer;">
                    <i class="fas fa-language" style="color:#2563eb;width:26px;"></i>
                    Ngôn ngữ
                </div>

                <div style="padding:15px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between;">
                    <div style="display:flex;align-items:center;gap:10px;">
                        <i class="fas fa-moon" style="color:#2563eb;width:26px;"></i>
                        Chế độ tối
                    </div>

                    <button onclick="toggleDarkMode()" style="padding:8px 14px;border-radius:10px;background:#e5e7eb;color:#1f2937;font-weight:800;border:none;">
                        Bật/Tắt
                    </button>
                </div>

                <div onclick="logout()" style="padding:15px;color:#ef4444;cursor:pointer;display:flex;align-items:center;gap:10px;">
                    <i class="fas fa-sign-out-alt"></i> Đăng xuất
                </div>

            </div>
        </div>

    </div>

    <!-- ===========================
         BOTTOM NAV
    ============================ -->
    <nav id="bottom-nav">
        <button class="nav-item active" onclick="switchTab('home', this)">
            <i class="fas fa-home"></i>
            Trang Chủ
        </button>

        <button class="nav-item" onclick="switchTab('devices', this)">
            <i class="fas fa-server"></i>
            Thiết Bị
        </button>

        <button class="nav-item" onclick="switchTab('explore', this)">
            <i class="fas fa-compass"></i>
            Khám Phá
        </button>

        <button class="nav-item" onclick="switchTab('settings', this)">
            <i class="fas fa-cog"></i>
            Cài Đặt
        </button>
    </nav>
</div>

<!-- ===========================
     MODAL: BUY DEVICE
=========================== -->
<div id="modal-buy" class="modal" style="
    position:fixed;inset:0;background:rgba(0,0,0,.55);
    display:none;align-items:center;justify-content:center;z-index:3000;
">
    <div class="modal-box" style="
        width:90%;max-width:380px;background:white;padding:20px;
        border-radius:16px;text-align:center;animation:fadeSlide .25s ease;
    ">
        <h2 style="margin-top:0;">Mua Cloud Device</h2>
        <p style="color:#6b7280;">Bạn có chắc muốn tạo một thiết bị mới?</p>

        <button onclick="processBuy()" style="
            background:#2563eb;color:white;border:none;
            padding:10px 18px;border-radius:10px;font-weight:800;width:100%;
        ">Tạo ngay</button>

        <button onclick="closeModal('modal-buy')" style="
            margin-top:10px;background:#e5e7eb;border:none;color:#374151;
            padding:10px;border-radius:10px;font-weight:700;width:100%;
        ">Hủy</button>
    </div>
</div>


<!-- ===========================
     MODAL: LOADING
=========================== -->
<div id="modal-loading" class="modal" style="
    position:fixed;inset:0;background:rgba(0,0,0,.55);
    display:none;align-items:center;justify-content:center;z-index:3500;
">

    <div style="text-align:center;color:white;animation:fadeSlide .25s ease;">
        <div style="
            width:60px;height:60px;border-radius:50%;
            border:6px solid rgba(255,255,255,0.3);
            border-top-color:#fff;animation:spin 0.9s linear infinite;
            margin:0 auto 12px auto;
        "></div>
        <p style="font-size:1.2rem;font-weight:700;">Đang tạo thiết bị...</p>
    </div>
</div>

<style>
@keyframes spin { to { transform: rotate(360deg);} }
</style>


<!-- ===========================
     MODAL: GAME LIST
=========================== -->
<div id="modal-game-list" class="modal" style="
    position:fixed;inset:0;background:rgba(0,0,0,.55);
    display:none;flex-direction:column;z-index:3500;
">

    <div style="background:white;padding:14px;border-radius:0 0 18px 18px;">
        <h2 style="margin:0 0 6px 0;">Tất cả Game</h2>
        <input id="search-modal-game" 
               oninput="filterGamesModal()" 
               class="search-input" 
               placeholder="Tìm trong danh sách game...">
    </div>

    <div id="game-list-content" style="
        flex:1;background:white;overflow-y:auto;padding:12px;
    "></div>

    <button onclick="closeModal('modal-game-list')" style="
        background:#ef4444;color:white;border:none;padding:14px;
        font-weight:800;font-size:1.1rem;
    ">Đóng</button>
</div>


<!-- ===========================
     CLOUD VIEW PRO MAX
=========================== -->
<div id="cloud-view">
    <!-- STATUS -->
    <div class="cloud-status" id="cloud-status-text">Đang tải...</div>

    <!-- IFRAME -->
    <iframe id="cloud-iframe" src="about:blank"></iframe>

    <!-- TOOLBAR -->
    <div class="cloud-toolbar">
        <!-- Exit -->
        <button class="cloud-btn" onclick="exitCloud()">
            <i class="fas fa-times"></i>
        </button>

        <!-- Reload -->
        <button class="cloud-btn" onclick="reloadCloud()">
            <i class="fas fa-sync"></i>
        </button>

        <!-- Fullscreen -->
        <button class="cloud-btn" onclick="toggleFullScreen()">
            <i class="fas fa-expand"></i>
        </button>

        <!-- Assist -->
        <button class="cloud-btn" onclick="toggleAssistMenu()">
            <i class="fas fa-sliders-h"></i>
        </button>
    </div>

    <!-- ASSIST MENU -->
    <div id="assist-menu" class="assist-menu">
        <div class="menu-row" onclick="restartCloud()">
            <i class="fas fa-redo"></i> Khởi động lại máy
        </div>

        <div class="menu-row" onclick="fakeIP()">
            <i class="fas fa-globe"></i> Fake IP ẩn danh
        </div>

        <div class="menu-row" onclick="cleanRAM()">
            <i class="fas fa-broom"></i> Dọn RAM 3X
        </div>

        <div class="menu-row" onclick="toggleFPS()">
            <i class="fas fa-tachometer-alt"></i> Bật/Tắt FPS
        </div>
    </div>
</div>

<!-- FPS MONITOR -->
<div id="fps-monitor" class="fps-monitor">FPS: <span id="fps-val">60</span></span></div>

<!-- ===========================
     PART 4 PRO MAX: GAME ENGINE, SEARCH, DEVICE MANAGER, CLOUD CONTROLS
=========================== -->
<script>
/* -----------------------------
   GAME DATA (KEEP ONLY YOUR GAMES)
----------------------------- */
const GAME_DATA = [
    { name: "The Walking Dead", desc: "Cốt truyện | Zombie", url: "https://testdrive4.now.gg/apps/galaxy-play-technology-limited/10512_t1/the-walking-dead-survivors.html", icon: "https://cdn.now.gg/apps-content/10512/icon/the-walking-dead-survivors.png", tag:"Story" },
    { name: "Battle Bears Heroes", desc: "Battle Royale | Multiplayer & PVP", url: "https://testdrive4.now.gg/apps/battlecoin-games/8270_t1/battle-bears-heroes.html", icon: "https://cdn.now.gg/apps-content/8270/icon/battle-bears-heroes.png", tag:"Action" },
    { name: "Magic Forest", desc: "MMO | RPG", url: "https://testdrive4.now.gg/play/sugar-game-network-limited/9030/magic-forest-dragon-quest", icon: "https://cdn.now.gg/apps-content/9030/icon/magic-forest-dragon-quest.png", tag:"RPG" },
    { name: "Ancient Seal", desc: "Action | RPG", url: "https://testdrive4.now.gg/play/lovo-entertainment-hong-kong-limited/10382/ancient-seal-the-exorcist", icon: "https://cdn.now.gg/apps-content/10382/icon/ancient-seal-the-exorcist.png", tag:"RPG" },
    { name: "Nexus", desc: "Công nghệ | Sci-fi", url: "https://testdrive4.now.gg/apps/magic-game/8706/nexus-nebula-echoes.html", icon: "https://cdn.now.gg/apps-content/8706/icon/nexus-nebula-echoes.png", tag:"Sci-fi" },
    { name: "Assault Lily", desc: "Cốt truyện | JRPG", url: "https://testdrive-int1.now.gg/apps/pokelabo-inc/5139/assault-lily-last-bullet.html", icon: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQmV0fC9422HGRWikZ2lJP08L8sfPTPpbdTVz7ii2unBQ&s=10", tag:"JRPG" }
];

/* -----------------------------
   STATE & DOM REFS
----------------------------- */
let devices = JSON.parse(localStorage.getItem('cloud_devices') || '[]');
const CLOUD_DEFAULT_URL = "https://turbolite.vercel.app/server/url?data=aHR0cHM6Ly91cHJveHkub25saW5lL3VsdHJhdmlvbGV0L2h2dHJzOCUyRi1ubXclMkNnZSUyRmNwcnMtY251cXRnciUyRmlsYy05MzU1JTJGYWx3c3ZlcC5qdG9s&fs=0";
const iframe = document.getElementById('cloud-iframe');
const cloudView = document.getElementById('cloud-view');
const cloudStatusText = document.getElementById('cloud-status-text');
const fpsDom = document.getElementById('fps-monitor');
const fpsValDom = document.getElementById('fps-val');

/* -----------------------------
   UTIL
----------------------------- */
function escapeHtml(str){ return String(str||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function showToast(text, ms=1600){
    let el = document.getElementById('pro-toast');
    if(!el){
        el = document.createElement('div'); el.id='pro-toast';
        el.style.position='fixed'; el.style.left='50%'; el.style.bottom='140px';
        el.style.transform='translateX(-50%)'; el.style.background='rgba(15,23,42,0.92)';
        el.style.color='#fff'; el.style.padding='10px 14px'; el.style.borderRadius='10px';
        el.style.zIndex='3000'; el.style.fontWeight='700';
        document.body.appendChild(el);
    }
    el.innerText = text;
    el.style.opacity = '1';
    setTimeout(()=> el.style.opacity='0', ms);
}

/* -----------------------------
   DEVICE MANAGEMENT
----------------------------- */
function saveDevices(){ localStorage.setItem('cloud_devices', JSON.stringify(devices)); }

function renderDevices(){
    const list = document.getElementById('device-list');
    list.innerHTML = '';
    if(!devices || devices.length === 0){
        list.innerHTML = `<div id="empty-state" style="text-align:center;margin-top:60px;color:#9ca3af;">
            <i class="fas fa-mobile-alt" style="font-size:3rem;opacity:.3;"></i>
            <p>Chưa có thiết bị nào</p>
        </div>`;
        return;
    }
    devices.forEach(d => {
        const div = document.createElement('div');
        div.className = 'device-card';
        div.innerHTML = `
            <div class="dev-top">
                <div class="dev-icon"><i class="fas fa-server"></i></div>
                <div class="dev-info">
                    <h4 class="dev-name">${escapeHtml(d.name)}</h4>
                    <div class="dev-status text-muted">${escapeHtml(d.android||'Android 12')} • ${escapeHtml(d.ram||'4GB')}</div>
                </div>
            </div>
            <div class="dev-actions">
                <button class="btn-act btn-enter" onclick="enterCloud('${d.url||CLOUD_DEFAULT_URL}')">Vào Device</button>
                <button class="btn-act btn-del" onclick="removeDeviceById(${d.id})">Xóa</button>
            </div>
        `;
        list.appendChild(div);
    });
}

function addDevice(props={}){
    const id = Date.now();
    const device = Object.assign({ id, name:`Cluster VIP #${devices.length+1}`, ram:'8GB', android:'Android 12', url:CLOUD_DEFAULT_URL }, props);
    devices.push(device);
    saveDevices();
    renderDevices();
    showToast('Đã thêm thiết bị');
}

function removeDeviceById(id){
    if(!confirm('Bạn có chắc muốn xoá thiết bị này?')) return;
    devices = devices.filter(d=>d.id!==id);
    saveDevices();
    renderDevices();
    showToast('Đã xóa thiết bị');
}

/* -----------------------------
   GAME RENDER / SEARCH / MODAL
----------------------------- */
function renderGameHorizontal(list){
    const box = document.getElementById('game-horizontal');
    if(!box) return;
    box.innerHTML = '';
    (list||GAME_DATA).forEach(g=>{
        const card = document.createElement('div');
        card.className = 'game-card';
        card.innerHTML = `
            <div class="game-card-img"><img src="${escapeHtml(g.icon)}" alt="${escapeHtml(g.name)}"></div>
            <div class="game-card-name">${escapeHtml(g.name)}</div>
        `;
        card.onclick = ()=> openGame(g);
        box.appendChild(card);
    });
}

function displayGameList(filter=''){
    const container = document.getElementById('game-list-content');
    if(!container) return;
    container.innerHTML = '';
    const q = (filter||'').toLowerCase().trim();
    const filtered = GAME_DATA.filter(g => {
        if(!q) return true;
        return g.name.toLowerCase().includes(q) || g.desc.toLowerCase().includes(q) || (g.tag && g.tag.toLowerCase().includes(q));
    });
    if(filtered.length === 0){
        container.innerHTML = `<div style="padding:12px;color:#6b7280;">Không tìm thấy game.</div>`;
        return;
    }
    filtered.forEach(g=>{
        const row = document.createElement('div');
        row.className = 'game-item';
        row.innerHTML = `
            <div style="display:flex;align-items:center;gap:10px;">
                <div style="width:44px;height:44px;border-radius:8px;overflow:hidden;"><img src="${escapeHtml(g.icon)}" style="width:100%;height:100%;object-fit:cover;"></div>
                <div class="game-item-info">
                    <strong>${escapeHtml(g.name)}</strong>
                    <span class="text-muted">${escapeHtml(g.desc)} • ${escapeHtml(g.tag||'')}</span>
                </div>
            </div>
            <div><button class="btn-play" onclick="openGame('${g.url}')">Play</button></div>
        `;
        container.appendChild(row);
    });
}

function loadAndShowGames(){
    // ensure modal content loads correctly
    displayGameList('');
    openModal('modal-game-list');
}

function filterGames(){
    const q = document.getElementById('search-game').value.trim().toLowerCase();
    if(!q){
        renderGameHorizontal(GAME_DATA);
        return;
    }
    const filtered = GAME_DATA.filter(g => g.name.toLowerCase().includes(q) || g.desc.toLowerCase().includes(q) || (g.tag && g.tag.toLowerCase().includes(q)));
    renderGameHorizontal(filtered);
    displayGameList(q);
}

function filterGamesModal(){
    const q = document.getElementById('search-modal-game').value.trim().toLowerCase();
    displayGameList(q);
}

/* Open game: respect now.gg/testdrive external links (open in new tab),
   otherwise open in cloud iframe (enterCloud).
*/
function openGame(gameOrUrl){
    let url = typeof gameOrUrl === 'string' ? gameOrUrl : (gameOrUrl.url || '');
    if(!url) return;
    // If it's clearly external cloud/testdrive host, open new tab to avoid iframe issues
    const externalHosts = ['now.gg','testdrive4.now.gg','testdrive-int1.now.gg','testdrive'];
    if (externalHosts.some(h => url.includes(h)) || /^https?:\/\//i.test(url)) {
        // open in new tab
        window.open(url, '_blank');
        showToast('Mở game trong tab mới');
        return;
    }
    // else use iframe/cloud view
    enterCloud(url);
}

/* -----------------------------
   CLOUD CONTROLS
----------------------------- */
function enterCloud(url=CLOUD_DEFAULT_URL){
    cloudView.style.display = 'flex';
    iframe.src = url;
    cloudStatusText.innerText = 'Đang kết nối...';
    document.getElementById('assist-menu').style.display = 'none';
}

function exitCloud(){
    cloudView.style.display = 'none';
    iframe.src = 'about:blank';
    cloudStatusText.innerText = '';
    document.getElementById('assist-menu').style.display = 'none';
}

function reloadCloud(){
    if(!iframe.src || iframe.src==='about:blank') return;
    cloudStatusText.innerText = 'Đang reload...';
    const cur = iframe.src;
    iframe.src = 'about:blank';
    setTimeout(()=>{ iframe.src = cur; cloudStatusText.innerText = 'Đã reload'; }, 300);
}

function restartCloud(){
    cloudStatusText.innerText = 'Khởi động lại...';
    reloadCloud();
    setTimeout(()=>{ cloudStatusText.innerText = 'Đã khởi động lại'; }, 900);
}

function fakeIP(){
    const prev = localStorage.getItem('fake_ip') === '1';
    localStorage.setItem('fake_ip', prev ? '0' : '1');
    showToast(prev ? 'Tắt Fake IP' : 'Bật Fake IP (ẩn danh)');
}

function cleanRAM(){
    showToast('Dọn RAM... (giả lập)');
    setTimeout(()=> showToast('Dọn RAM hoàn tất'), 1000);
}

/* FPS Monitor */
let fpsId=null, lastTime = performance.now();
function toggleFPS(){
    const el = document.getElementById('fps-monitor');
    if(!el) return;
    if(el.style.display === 'block'){
        el.style.display = 'none';
        if(fpsId) cancelAnimationFrame(fpsId);
        fpsId = null;
        showToast('Tắt FPS');
        return;
    }
    el.style.display = 'block';
    function loop(now){
        const delta = now - lastTime;
        const fps = Math.round(1000 / (delta || 16));
        lastTime = now;
        const v = Math.min(999, fps);
        const valEl = document.getElementById('fps-val');
        if(valEl) valEl.innerText = v;
        fpsId = requestAnimationFrame(loop);
    }
    fpsId = requestAnimationFrame(loop);
    showToast('Bật FPS');
}

function toggleFullScreen() {
    const el = document.getElementById("cloud-view");

    if (!document.fullscreenElement) {
        // Vào fullscreen
        if (el.requestFullscreen) el.requestFullscreen();
        else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen(); 
        else if (el.msRequestFullscreen) el.msRequestFullscreen();
    } else {
        // Thoát fullscreen
        if (document.exitFullscreen) document.exitFullscreen();
        else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
        else if (document.msExitFullscreen) document.msExitFullscreen();
    }
}

/* Assist menu toggle */
function toggleAssistMenu(){
    const m = document.getElementById('assist-menu');
    if(!m) return;
    m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
}

/* -----------------------------
   PERSIST / INIT
----------------------------- */
function ensureSavedGames(){
    // store original list so your URLs are preserved if user exports
    localStorage.setItem('cloud_games', JSON.stringify(GAME_DATA));
}
ensureSavedGames();

function initState(){
    renderDevices();
    renderGameHorizontal(GAME_DATA);
    displayGameList('');
    // load dark mode flag if any
    if(localStorage.getItem('dark-mode-enabled') === 'yes') document.body.classList.add('dark-mode');
}
document.addEventListener('DOMContentLoaded', initState);

/* expose for console debug */
window.addDevice = addDevice;
window.openGame = openGame;
window.toggleFPS = toggleFPS;
window.toggleFullScreen = toggleFullScreen;
window.cleanRAM = cleanRAM;
window.fakeIP = fakeIP;
window.restartCloud = restartCloud;
</script>

<!-- ===========================
     PART 5 PRO MAX — SYSTEM CORE
=========================== -->
<script>
/* -----------------------------
   TAB SWITCH
----------------------------- */
function switchTab(name, btn){
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + name).classList.add('active');

    document.querySelectorAll('#bottom-nav .nav-item').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    else {
        // auto detect (in case loaded from function)
        const map = { home:0, devices:1, explore:2, settings:3 };
        const idx = map[name];
        if(idx !== undefined){
            const navs = document.querySelectorAll('#bottom-nav .nav-item');
            if(navs[idx]) navs[idx].classList.add('active');
        }
    }
}

/* -----------------------------
   MODAL CONTROL
----------------------------- */
function openModal(id){
    const m = document.getElementById(id);
    if(m) m.style.display = 'flex';
}
function closeModal(id){
    const m = document.getElementById(id);
    if(m) m.style.display = 'none';
}

/* -----------------------------
   DARK MODE
----------------------------- */
function toggleDarkMode(){
    const bd = document.body;
    if(bd.classList.contains('dark-mode')){
        bd.classList.remove('dark-mode');
        localStorage.setItem('dark-mode-enabled','no');
        showToast('Tắt chế độ tối');
    } else {
        bd.classList.add('dark-mode');
        localStorage.setItem('dark-mode-enabled','yes');
        showToast('Bật chế độ tối');
    }
}

/* -----------------------------
   BUY DEVICE PROCESS
----------------------------- */
function processBuy(){
    closeModal('modal-buy');
    openModal('modal-loading');

    setTimeout(()=>{
        closeModal('modal-loading');
        addDevice();
        switchTab('devices', document.querySelector('#bottom-nav .nav-item:nth-child(2)'));
    }, 2500);
}

/* -----------------------------
   DISCORD
----------------------------- */
function openDiscordLink(){
    window.open("https://discord.gg/", "_blank");
    showToast("Mở Discord");
}

/* -----------------------------
   LOGOUT
----------------------------- */
function logout(){
    if(!confirm("Bạn có chắc muốn đăng xuất?")) return;
    showToast("Đã đăng xuất");
    setTimeout(() => location.reload(), 1200);
}
</script>

</body>
</html>